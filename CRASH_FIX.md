# 应用崩溃问题修复

## 🚨 崩溃分析

**错误信息**：
```
Fatal signal 6 (SIGABRT), code -1 (SI_QUEUE)
utils::TPanic<utils::PreconditionPanic>::panic
```

**可能原因**：
1. **文件损坏**：复制的 `background.ktx` 文件可能格式不正确
2. **API 调用时机**：在 viewer 未完全初始化时调用环境切换
3. **资源冲突**：同时加载多个环境资源导致冲突
4. **内存问题**：环境文件过大导致内存不足

## 🔧 修复措施

### 1. 移除问题文件
- 删除了 `background_ibl.ktx` 和 `background_skybox.ktx`
- 只使用已知稳定的 `default_env_*.ktx` 文件

### 2. 添加安全检查
```dart
bool _viewerInitialized = false;

// 在环境切换前检查初始化状态
if (!_viewerInitialized) return;
```

### 3. 改进错误处理
- 添加详细的调试日志
- 使用正确的 API 方法 (`removeSkybox()` 而不是空字符串)
- 添加 `destroyExisting: true` 参数

### 4. 移除自动测试
- 移除了初始化后的自动环境切换测试
- 避免在启动时触发不稳定的操作

## 🎯 当前可用功能

### 安全的环境选项
1. **默认环境** - 使用原有的稳定环境文件
2. **简约环境** - 同样的 IBL，但无 skybox（纯色背景）

### 控制功能
- ✅ IBL 强度调节 (10K-80K)
- ✅ Skybox 开关
- ✅ 强度预设按钮
- ✅ 悬浮控制面板

## 🚀 下一步计划

### 短期（稳定性优先）
1. 确保当前版本稳定运行
2. 测试 IBL 强度调节功能
3. 测试 Skybox 开关功能

### 中期（环境扩展）
1. 从 Poly Haven 下载标准 HDRI 文件
2. 使用 Filament 的 `cmgen` 工具正确转换
3. 逐个测试新环境文件

### 长期（高级功能）
1. 实时 HDRI 上传和转换
2. 用户自定义环境
3. 环境预览功能

## 📋 安全使用指南

1. **启动应用**：确保无崩溃，数字人正常显示
2. **打开控制面板**：点击右上角 tune 按钮
3. **测试 IBL 强度**：使用滑块或预设按钮调节
4. **测试 Skybox 开关**：观察背景变化
5. **谨慎切换环境**：目前只有两个安全选项

现在的版本应该是稳定的，不会再崩溃。